<?xml version="1.0"?>

<robot 
  xmlns:sensor="http://playerstage.sourceforge.net/gazebo/xmlschema/#sensor"
  xmlns:controller="http://playerstage.sourceforge.net/gazebo/xmlschema/#controller"
  xmlns:interface="http://playerstage.sourceforge.net/gazebo/xmlschema/#interface"
  xmlns:xacro="http://www.ros.org/wiki/xacro" name="talos">

  <include filename="$(find talos_description)/urdf/sensors/hokuyo_lx30_laser.urdf.xacro" />

  <property name="M_PI" value="3.14159265359" />

  <property name="caster_offset_x" value="0.25"/>
  <property name="caster_offset_y" value="0.2175"/>
  <property name="caster_offset_z" value="-0.22"/>

  <!-- base laser -->
  <property name="base_laser_x" value="0"/>
  <property name="base_laser_y" value="0"/>
  <property name="base_laser_z" value="0"/>

  <property name="caster_wheel_length" value="0.0261"/>
  <property name="caster_wheel_radius" value="0.0525"/>
  <property name="caster_wheel_y_offset" value="0.01"/>

  <!-- drive wheel distance from right edge: 73mm
       drive wheel distance from back edge: 100mm
       drive wheel distance from bottom: 40mm -->
  <property name="drive_wheel_length" value="0.013"/>
  <property name="drive_wheel_radius" value="0.0789"/>
  <property name="drive_wheel_y_offset" value="0.01"/>
  <property name="drive_wheel_offset_x" value="0.2"/>
  <property name="drive_wheel_offset_y" value="0.227"/>
  <property name="drive_wheel_offset_z" value="-0.19"/>

  <!-- simplified box collision geometry for base -->
  <property name="base_size_x" value="0.6" />
  <property name="base_size_y" value="0.6" />
  <property name="base_size_z" value="0.3" />
  <property name="base_collision_size_z" value="0"/>

  <!-- simplified box collision geometry for planar laser -->
  <property name="base_laser_x" value="0.3"/>
  <property name="base_laser_y" value="0"/>
  <property name="base_laser_z" value="0.15"/>
  <property name="base_laser_size_x" value="0.05"/>
  <property name="base_laser_size_y" value="0.05"/>
  <property name="base_laser_size_z" value="0.07"/>
  <property name="base_laser_collision_offset_z" value="0"/>

  
  <xacro:macro name="talos_base_v0" params="name">

    <link name="${name}_link">
      <visual>
        <geometry>
          <box size="${base_size_x} ${base_size_y} ${base_size_z}"/>
        </geometry>
        <material name="transparent_grey">
          <color rgba="1 0.8 0.8 0.3"/>
        </material>
      </visual>
    </link>

    <link name="${name}_footprint">

      <inertial>
        <mass value="1.0" />
        <origin xyz="0 0 0" />
        <inertia ixx="0.01" ixy="0.0" ixz="0.0"
                 iyy="0.01" iyz="0.0" izz="0.01" />
      </inertial>

      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <box size="0.01 0.01 0.01"/>
        </geometry>
        <material name="white" />
      </visual>

      <collision>
        <!-- represent base collision with a simple rectangular model, positioned by base_size_z s.t. top 
             surface of the collision box matches the top surface of the talos base -->
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <box size="0.001 0.001 0.001 " />
        </geometry>
      </collision>

    </link>

    <joint name="${name}_footprint_joint" type="fixed">
      <origin xyz="0 0 0.135" rpy="0 0 0"/>
      <child link="${name}_link" />
      <parent link="${name}_footprint" />
    </joint>

    <!-- base laser -->
    <!-- I believe the update_rate, min?_angle, and max_angle aren't correct as they're taken from the pr2's urg-lx30. we have the urg-04lx -->
    <xacro:hokuyo_lx30_laser_v0 name="${name}_laser" parent="${name}" ros_topic="base_scan" update_rate="20" min_angle="-2.2689" max_angle="2.2689" >
      <origin xyz="${base_laser_x} ${base_laser_y} ${base_laser_z}" rpy="0 0 0" />
    </xacro:hokuyo_lx30_laser_v0>

    <!-- caster wheels -->
    <xacro:talos_caster_v0 suffix="fl" parent="${name}_link">
      <origin xyz="${caster_offset_x} ${caster_offset_y} ${caster_offset_z}" rpy="0 0 0" />
    </xacro:talos_caster_v0>

    <xacro:talos_caster_v0 suffix="fr" parent="${name}_link">
      <origin xyz="${caster_offset_x} ${-caster_offset_y} ${caster_offset_z}" rpy="0 0 0" />
    </xacro:talos_caster_v0>

    <!-- drive wheels -->
    <xacro:talos_drive_v0 suffix="rl" parent="${name}_link">
      <origin xyz="${-drive_wheel_offset_x} ${drive_wheel_offset_y} ${drive_wheel_offset_z}" rpy="0 0 0"/>
    </xacro:talos_drive_v0>

    <xacro:talos_drive_v0 suffix="rr" parent="${name}_link">
      <origin xyz="${-drive_wheel_offset_x} ${-drive_wheel_offset_y} ${drive_wheel_offset_z}" rpy="0 0 0"/>
    </xacro:talos_drive_v0>

  </xacro:macro>

  <xacro:macro name="talos_drive_v0" params="parent suffix *origin">

    <xacro:talos_drive_hub_v0 parent="${parent}" suffix="${suffix}_drive" >
      <insert_block name="origin" />
    </xacro:talos_drive_hub_v0>

    <!-- drive wheel -->
    <xacro:talos_drive_wheel_v0 parent="${suffix}_drive" suffix="l" reflect="1" />

  </xacro:macro>

  <xacro:macro name="talos_drive_hub_v0" params="suffix parent *origin">

    <joint name="${suffix}_rotation_joint" type="continuous">
      <axis xyz="0 0 1" />
      <limit effort="6.5" velocity="10"/>
      <safety_controller k_velocity="10"/>
      <!--
      <calibration rising="${ref_position}" />
      -->
      <dynamics damping="1.0" friction="0.0" />
      <insert_block name="origin" />
      <parent link="${parent}"/>
      <child link="${suffix}_rotation_link" />
    </joint>

    <link name="${suffix}_rotation_link" >
    </link>

  </xacro:macro>

  <xacro:macro name="talos_drive_wheel_v0" params="parent suffix reflect">

    <joint name="${parent}_${suffix}_wheel" type="fixed">
      <axis xyz="0 1 0" />
      <limit effort="7" velocity="15"/> 
      <safety_controller  k_velocity="10" />
      <dynamics damping="1.0" friction="0.0" />
      <origin xyz="0 ${reflect*drive_wheel_y_offset} 0" rpy="0 0 0"/>
      <parent link="${parent}_rotation_link"/> 
      <child link="${parent}_${suffix}_wheel_link" />
    </joint>

    <link name="${parent}_${suffix}_wheel_link">
      <visual>
        <!--<origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/> --><!-- rotation bc cyl. geom prim has symmetry axis in +x dir -->
        <origin rpy="${M_PI/2} 0 0"/> <!-- rotation bc cyl. geom prim has symmetry axis in +x dir -->
        <geometry>
          <cylinder length="${drive_wheel_length}" radius="${drive_wheel_radius}"/>
        </geometry>
        <material name="black">
          <color rgba="0 0 0 1"/>
        </material>
      </visual>
    </link>

  </xacro:macro>

  <xacro:macro name="talos_caster_wheel_v0" params="parent suffix reflect">

    <joint name="${parent}_${suffix}_wheel" type="fixed">
      <axis xyz="0 1 0" />
      <limit effort="7" velocity="15"/> 
      <safety_controller  k_velocity="10" />
      <dynamics damping="1.0" friction="0.0" />
      <origin xyz="0 ${reflect*drive_wheel_y_offset} 0" rpy="0 0 0"/>
      <parent link="${parent}_rotation_link"/> 
      <child link="${parent}_${suffix}_wheel_link" />
    </joint>

    <link name="${parent}_${suffix}_wheel_link">
      <visual>
        <!--<origin xyz="0 0 0" rpy="${M_PI/2} 0 0"/> --><!-- rotation bc cyl. geom prim has symmetry axis in +x dir -->
        <origin rpy="${M_PI/2} 0 0"/> <!-- rotation bc cyl. geom prim has symmetry axis in +x dir -->
        <geometry>
          <cylinder length="${caster_wheel_length}" radius="${caster_wheel_radius}"/>
        </geometry>
        <material name="black">
          <color rgba="0 0 0 1"/>
        </material>
      </visual>
    </link>
    
  </xacro:macro>

  <xacro:macro name="talos_caster_hub_v0" params="suffix parent *origin">

    <joint name="${suffix}_rotation_joint" type="continuous">
      <axis xyz="0 0 1" />
      <limit effort="6.5" velocity="10"/>
      <safety_controller k_velocity="10"/>
      <!--
      <calibration rising="${ref_position}" />
      -->
      <dynamics damping="1.0" friction="0.0" />
      <insert_block name="origin" />
      <parent link="${parent}"/>
      <child link="${suffix}_rotation_link" />
    </joint>

    <link name="${suffix}_rotation_link" >
    </link>

  </xacro:macro>

  <xacro:macro name="talos_caster_v0" params="suffix parent *origin">
  
    <xacro:talos_caster_hub_v0 parent="${parent}" suffix="${suffix}_caster" >
      <insert_block name="origin" />
    </xacro:talos_caster_hub_v0>

    <!-- caster wheel -->
    <xacro:talos_caster_wheel_v0 parent="${suffix}_caster" suffix="l" reflect="1" />
    
  </xacro:macro>

  <gazebo reference="camera_link">
    <sensor:ray name="base_laser">
      <rayCount>640</rayCount>
      <rangeCount>640</rangeCount>
      <laserCount>1</laserCount>
      <origin>0.0 0.0 0.0</origin>
      <displayRays>false</displayRays>
      <minAngle>-129.998394137</minAngle>
      <maxAngle>129.998394137</maxAngle>
      <minRange>0.08</minRange>
      <maxRange>10.0</maxRange>
      <resRange>0.01</resRange>
      <updateRate>20</updateRate>
      <controller:gazebo_ros_laser name="gazebo_ros_base_laser_controller" plugin="libgazebo_ros_laser.so">
        <gaussianNoise>0.005</gaussianNoise>
        <alwaysOn>true</alwaysOn>
        <updateRate>20</updateRate>
        <topicName>scan</topicName>
        <frameName>base_laser</frameName>
        <interface:laser name="gazebo_ros_base_laser_iface"/>
      </controller:gazebo_ros_laser>
    </sensor:ray>
  </gazebo>

    <xacro:talos_base_v0 name="base"/>

</robot>
